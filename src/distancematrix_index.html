<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .axis path,
    .axis line {
        fill: none;
        stroke: none;
        shape-rendering: crispEdges;
    }

    .axis text {
        font-family: sans-serif;
        font-size: 12px;
    }
</style>
<body>
<svg></svg>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script type='text/javascript'>

    new QWebChannel(qt.webChannelTransport, function (channel) {

        var jsobject = channel.objects.distancematrix_data;
        let json_string = jsobject.json_string;
        
        let rect_width = 10;
        let rect_height = 10;

        let my_data = JSON.parse(json_string);

        console.log(my_data);

        var w = 1800,
            h = 300;

        var margin = {top: 20, right: 40, bottom: 10, left: 10};
        var width = w;

        var svg = d3.select('svg')
            .attr({
                'width': width + margin.left + margin.right,
                'height': h + margin.top + margin.bottom
            })
            .append('g')
            .attr({
                'transform': 'translate(' + margin.left + ',' + margin.top + ')',
                'width': width,
                'height': h
            });

        var corrplot = svg.append('g')
            .attr({
                'id': 'corrplot'
            });

        // corrplot.append('text')
        //     .text('Correlation matrix')
        //     .attr({
        //         'class': 'plottitle',
        //         'x': w / 2,
        //         'y': -margin.top / 2,
        //         'dominant-baseline': 'middle',
        //         'text-anchor': 'middle'
        //     });

        var corXscale = d3.scale.ordinal().rangeRoundBands([0, w]),
            corYscale = d3.scale.ordinal().rangeRoundBands([h, 0]),
            corColScale = d3.scale.linear().domain([0, 5]).range(['purple', 'white']);
        var corRscale = d3.scale.sqrt().domain([0, 1]);

        corXscale.domain(d3.range(my_data[0].synapses.length));
        corYscale.domain(d3.range(my_data.length));
        corRscale.range([0, 0.5 * corXscale.rangeBand()]);

        var corr = [];
        for (var i = 0; i < my_data.length; ++i) {
            for (var j = 0; j < my_data[i].synapses.length; ++j) {
                corr.push({row: i, col: j, value: my_data[i].synapses[j].distance});
            }
        }

        var cells = corrplot.append('g')
            .attr('id', 'cells')
            .selectAll('empty')
            .data(corr)
            .enter().append('g')
            .attr({
                'class': 'cell'
            })
            .style('pointer-events', 'all');

        var rects = cells.append('rect')
            .attr({
                'x': function (d) {
                    return corXscale(d.col) - rect_width / 2;
                },
                'y': function (d) {
                    return corXscale(d.row) - rect_height / 2;
                },
                'width': rect_width,
                'height': rect_height,
                'fill': 'none',
                'stroke': 'none',
                'stroke-width': '1'
            });

        var circles = cells.append('circle')
            .attr('cx', function (d) {
                return corXscale(d.col);
            })
            .attr('cy', function (d) {
                return corXscale(d.row);
            })
            .attr('r', function (d) {
                return 4;
            })
            .style('fill', function (d) {
                return corColScale(d.value);
            });

        corrplot.selectAll('g.cell')
            .on('mouseover', function (d) {
                d3.select(this)
                    .select('rect')
                    .attr('stroke', 'black');

                var xPos = parseFloat(d3.select(this).select('rect').attr('x'));
                var yPos = parseFloat(d3.select(this).select('rect').attr('y'));

                corrplot.append('text')
                    .attr({
                        'class': 'corrlabel',
                        'x': corXscale(d.col),
                        'y': h + margin.bottom * 0.2
                    })
                    .text(my_data[d.row].synapses[d.col].name)
                    .attr({
                        'dominant-baseline': 'middle',
                        'text-anchor': 'middle'
                    });


                corrplot.append('text')
                    .attr({
                        'class': 'corrlabel',
                    })
                    .text(my_data[d.row].name)
                    .attr({
                        'dominant-baseline': 'middle',
                        'text-anchor': 'middle',
                        'transform': 'translate(' + (-margin.left * 0.1) + ',' + corXscale(d.row) + ')rotate(270)'
                    });

                corrplot.append('rect')
                    .attr({
                        'class': 'tooltip',
                        'x': xPos + 10,
                        'y': yPos - 30,
                        'width': 40,
                        'height': 20,
                        'fill': 'rgba(200, 200, 200, 0.5)',
                        'stroke': 'black'
                    });

                corrplot.append('text')
                    .attr({
                        'class': 'tooltip',
                        'x': xPos + 30,
                        'y': yPos - 15,
                        'text-anchor': 'middle',
                        'font-family': 'sans-serif',
                        'font-size': '14px',
                        'font-weight': 'bold',
                        'fill': 'black'
                    })
                    .text(d3.format('.2f')(d.value));
            })
            .on('mouseout', function (d) {
                d3.select('#corrtext').remove();
                d3.selectAll('.corrlabel').remove();
                d3.select(this)
                    .select('rect')
                    .attr('stroke', 'none');
                //Hide the tooltip
                d3.selectAll('.tooltip').remove();
            })
            .on('click', function (d) {
                //drawScatter(d.col, d.row);
            });
    });


</script>